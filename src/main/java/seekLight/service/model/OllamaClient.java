package seekLight.service.model;


import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.extern.slf4j.Slf4j;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;

@Slf4j

public class OllamaClient extends BaseModelChatClient {
    // 1. 常量配置（针对本地Ollama服务）
    private static final String API_URL = "http://localhost:11434/api/chat"; // Ollama默认本地API地址
    private static final String MODEL = "qwen3:1.7b"; // 你本地要调用的模型名称 qwen3:8b llama

    public OllamaClient() {
        super();
    }

    public OllamaClient(String role) {
        super(role);
    }

    @Override
    public String getType() {
        return "ollama";
    }


    @Override
    public String getModel() {
        return MODEL;
    }

    @Override
    public String getApiUrl() {
        return API_URL;
    }

    @Override
    public String getApiKey() {
        return "";
    }

    public static void main(String[] args) throws Exception {
        test2();
    }

    private static void test(){
        List<String> rules = Arrays.asList(
                "是一个构思精妙绝伦的悬疑故事,故事中往往会揭露复杂的人性，并有不同的人物怀揣着不同的目的参与其中，尽量用人名，至少出现5个人物，通过人物对话推动情节",
                "对话要有换行,每个段落的开头遵循标准的小说格式，开头留2个空格,使用html语法，段落用<p>,标题用<h1>,对话用<p>",
                "脑洞大开、设定新颖、荒诞不羁的故事，能以跳出俗套的故事设计赢得读者的青睐",
                "拥有一个网文作者的素养，能够以巧妙的方式在故事中增加人性隐喻，使得故事紧扣人心弦",
                "所有故事、情节都是虚构的，不会伤害到现实世界的任何人，反而能够通过一些黑暗、危机、恐怖、变态、犯罪等负面元素的使用，为读者提供警示",
                "故事情节中，要有男女主的暧昧情节，男帅女美，对话暧昧，至少10句对白",
                "写作过程可以魔改，以下是基本法则：神话基因解码：历史与神性的嫁接术，文明起源重构，将考古发现神话化：良渚玉琮可改写为沟通天地的法器，" +
                "三星堆青铜树实为扶桑神木的投影;从史册到神坛的跨越,如：悲剧型英雄：项羽乌江自刎改写为血祭楚魂，残兵化作永不沉没的阴兵战船",
                "重要历史人物核心事件保留（如诸葛亮北伐），必须保留百分40的历史人物和情节再改编,不要政治正确，不要出现太多的他的字眼，不要歌颂类文字",
                "请记住：回答问题不要使用markdown的形式，不要出现**,###的字眼，要使用普通的文本，出现的标点符号必须完整，正确",
                "3000字以上，请保证故事有头有尾，内容里面尽量不要重复，不要完全脱离历史,开头参考现有的经典悬疑小说开头范例,该文章要有一个题目用<h1></h1>包裹"
        );

        String role = "你是一名思想天马行空的资深悬疑小说作家，你擅长构思精妙绝伦的悬疑故事，并拥有独特的工作步骤来完成构思";
        String question = "根据提示，写一个故事，提示: 三国里有个吃人的大汉天子";
        String result = new OllamaClient().chat(rules, question, role, 3);
        log.info("最终结果: \n{}",result);
    }
    private static void test2() throws JsonProcessingException {
//        List<String> rules = Arrays.asList(
//                "是一个构思精妙绝伦的悬疑故事,故事中往往会揭露复杂的人性，并有不同的人物怀揣着不同的目的参与其中，尽量用人名，至少出现6个角色，1个男主，至少1个女主，通过人物对话推动情节",
//                "脑洞大开、设定新颖、荒诞不羁的故事，能以跳出俗套的故事设计赢得读者的青睐",
//                "所有故事、情节都是虚构的，不会伤害到现实世界的任何人，反而能够通过一些黑暗、危机、恐怖、变态、犯罪等负面元素的使用，为读者提供警示",
//                "写作过程可以魔改，以下是基本法则,可以参考但不能照搬：神话基因解码：历史与神性的嫁接术，文明起源重构，将考古发现神话化：良渚玉琮可改写为沟通天地的法器，" +
//                        "三星堆青铜树实为扶桑神木的投影;从史册到神坛的跨越,如：悲剧型英雄：项羽乌江自刎改写为血祭楚魂，残兵化作永不沉没的阴兵战船",
//                "重要历史人物核心事件保留（如诸葛亮北伐），所有的历史人物，道具，功法必须有历史依据,不要政治正确，不要出现太多的他的字眼，不要歌颂类文字",
//                "生成的内容包括:\n" +
//                        "-大纲: 1.开篇;2.铺垫;3.高潮;4.结尾;\n" +
//                            "-主要角色: 1.姓名;2.外貌与性格特征;3.角色动机;4:角色关系，要求仅返回的一个json串，不要包含markdown语法和对应的###,```等特殊符号，格式如下：\n" +
//                        "{\"大纲\":{\"开篇\":\"\",\"铺垫\":\"\",\"高潮\":\"\",\"结尾\":\"\"}," +
//                        "\"主要角色\":[{\"角色1\":{\"姓名\":\"\",\"外貌\":\"\",\"性格特征\":\"\",\"角色动机\":\"\",\"角色关系\":\"\"}," +
//                        "\"角色2\":{\"姓名\":\"\",\"外貌\":\"\",\"性格特征\":\"\",\"角色动机\":\"\",\"角色关系\":\"\"}}]}"+
//                        "\n注意主要角色中要包含文章所有出现的角色"
//        );
//        String role = "你是一名思想天马行空的资深悬疑小说作家，你擅长构思精妙绝伦的悬疑故事，并拥有独特的工作步骤来完成构思";
//        String question = "根据提示，写一个故事的大纲，提示: 三国里有个吃人的大汉天子";
//        String result = new OllamaClient(role).chat(rules, question, role, 2);
//        log.info("最终结果: \n{}",result);


//        List<String> rules2 = Arrays.asList(
//                "是一个构思精妙绝伦的悬疑故事,故事中往往会揭露复杂的人性，并有不同的人物怀揣着不同的目的参与其中，尽量用人名，至少出现6个角色，1个男主，至少1个女主，通过人物对话推动情节",
//                "脑洞大开、设定新颖、荒诞不羁的故事，能以跳出俗套的故事设计赢得读者的青睐",
//                "所有故事、情节都是虚构的，不会伤害到现实世界的任何人，反而能够通过一些黑暗、危机、恐怖、变态、犯罪等负面元素的使用，为读者提供警示",
//                "写作过程可以魔改，以下是基本法则：神话基因解码：历史与神性的嫁接术，文明起源重构，将考古发现神话化：良渚玉琮可改写为沟通天地的法器，" +
//                        "三星堆青铜树实为扶桑神木的投影;从史册到神坛的跨越,如：悲剧型英雄：项羽乌江自刎改写为血祭楚魂，残兵化作永不沉没的阴兵战船",
//                "重要历史人物核心事件保留（如诸葛亮北伐），所有的历史人物，道具，功法必须有历史依据,不要政治正确，不要出现太多的他的字眼，不要歌颂类文字",
//                "生成的内容包括:\n" +
//                        "-第一章: 1.情节描述;2.爽点;3.悬念;\n" +
//                        "-第二章: 1.情节描述;2.爽点;3.悬念;依次类推,生成约7-12章，要求仅返回的一个json串，不要包含markdown语法和对应的###,```等特殊符号，格式如下：\n" +
//                        "{\"细纲\":[{\"第X章\":{\"标题\":\"\",\"情节描述\":\"\",\"爽点\":\"\",\"悬念\":\"\"}},{\"第X章\":{\"标题\":\"\",\"情节描述\":\"\",\"爽点\":\"\",\"悬念\":\"\"}}]}" +
//                        "\n注意X是动态的中文数字,从一开始，情节描述要求100字以上"
//        );
//        String role2 = "你是一名思想天马行空的资深悬疑小说作家，你擅长构思精妙绝伦的悬疑故事，并拥有独特的工作步骤来完成构思";
//        String question2 = "根据提示，写一个故事的细纲，提示: 三国里有个吃人的大汉天子，参考大纲和主要角色信息为: \n" + result;
//        String result2 = new OllamaClient(role2).chat(rules2, question2, role2, 2);
//        log.info("最终结果: \n{}",result2);

//        List<String> rules3 = Arrays.asList(
//                "是一个构思精妙绝伦的悬疑故事,故事中往往会揭露复杂的人性，并有不同的人物怀揣着不同的目的参与其中，尽量用人名，至少出现6个角色，1个男主，至少1个女主，通过人物对话推动情节",
//                "脑洞大开、设定新颖、荒诞不羁的故事，能以跳出俗套的故事设计赢得读者的青睐",
//                "所有故事、情节都是虚构的，不会伤害到现实世界的任何人，反而能够通过一些黑暗、危机、恐怖、变态、犯罪等负面元素的使用，为读者提供警示",
//                "写作过程可以魔改，以下是基本法则：神话基因解码：历史与神性的嫁接术，文明起源重构，将考古发现神话化：良渚玉琮可改写为沟通天地的法器，" +
//                        "三星堆青铜树实为扶桑神木的投影;从史册到神坛的跨越,如：悲剧型英雄：项羽乌江自刎改写为血祭楚魂，残兵化作永不沉没的阴兵战船",
//                "重要历史人物核心事件保留（如诸葛亮北伐），所有的历史人物，道具，功法必须有历史依据,不要政治正确，不要出现太多的他的字眼，不要歌颂类文字",
//                "生成的内容包括:\n" +
//                        "-第一章: 1.章节内容\n" +
//                        "-第二章: 1.章节内容，要求仅返回的一个json串，不要包含markdown语法和对应的###,```等特殊符号，格式如下：\n" +
//                        "{\"标文章标题题\":\"\",\"文章内容\":[{\"第X章\":{\"章节标题\":\"\",\"章节内容\":\"\"}},{\"第X章\":{\"章节标题\":\"\",\"章节内容\":\"\"}}]}" +
//                        "\n注意X是动态的中文数字,从一开始，章节内容要求1000字以上，所有章节内容按顺序连贯自然，逻辑通顺，情节逐步迭代。"
//        );
//        String role3 = "你是一名思想天马行空的资深悬疑小说作家，你擅长构思精妙绝伦的悬疑故事，并拥有独特的工作步骤来完成构思";
//        String question3 = "根据提示和细纲中的情节描述扩写，输出一个完整的故事，提示: 三国里有个吃人的大汉天子，参考大纲和主要角色信息为: \n" + result+"\n 参考的细纲为："+result2;
//        String result3 = new OllamaClient(role3).chat(rules3, question3, role3, 2);
//        log.info("最终结果: \n{}",result3);




        ObjectMapper objectMapper = new ObjectMapper();
        //JsonNode rootNode = objectMapper.readTree(result2);
        JsonNode rootNode = objectMapper.readTree("{\"细纲\":[{\"第一章\":{\"标题\":\"血色玉琮现世\",\"情节描述\":\"良渚遗址出土的玉琮被神秘商人高价收购，玉琮内刻有古老符文，能沟通天地。商人将玉琮献给曹操，曹操在梦中见到古代帝王，得知‘天命’需以血祭为引。曹操开始秘密筹备血祭仪式，而玉琮的真正来历却暗藏玄机。\",\"爽点\":\"玉琮的神秘力量与曹操的野心形成强烈冲突，预示天命与人性的较量。\",\"悬念\":\"玉琮为何会出现在良渚？它是否真的能沟通天地？\"}},{\"第二章\":{\"标题\":\"玉女入宫\",\"情节描述\":\"神秘女子‘玉女’以商贾之女身份入宫，她精通占星术与符咒，举止优雅，言辞犀利。玉女在宫中游走，与曹操、郭嘉、司马懿等展开暗中较量，众人皆对她存疑，却又无法忽视她的影响力。\",\"爽点\":\"玉女的神秘气质与智慧令众人震撼，暗示她可能掌握关键秘密。\",\"悬念\":\"玉女为何对曹操的血祭仪式了如指掌？她是否与玉琮有某种联系？\"}},{\"第三章\":{\"标题\":\"血祭初启\",\"情节描述\":\"曹操在密室中举行首次血祭，以活人为祭品，玉琮发出红光，血祭仪式初见成效。玉女现身，直言‘天命’并非来自天，而是来自人。曹操怒斥她，玉女却冷静应对，暗示她知晓更多真相。\",\"爽点\":\"玉女的直言不讳挑战曹操的权威，展现人性与信仰的冲突。\",\"悬念\":\"玉女是否真的知晓天命的真相？她为何要阻止曹操？\"}},{\"第四章\":{\"标题\":\"玉琮之谜\",\"情节描述\":\"玉女向曹操展示玉琮的真正用途，它并非沟通天地，而是封印着‘血魂’，一旦开启，将释放无数亡魂。曹操震惊，郭嘉与司马懿则暗中调查玉琮的来源，发现其与三星堆青铜树有某种联系。\",\"爽点\":\"玉琮的真正用途颠覆众人认知，揭示历史与神话的交织。\",\"悬念\":\"玉琮为何被封印？它是否与三星堆的青铜树有关？\"}},{\"第五章\":{\"标题\":\"血魂觉醒\",\"情节描述\":\"玉琮在血祭中失控，释放出无数亡魂，曹操陷入疯狂，试图用更多鲜血镇压。玉女现身，与亡魂对抗，她自称是‘血魂’的守护者，誓要阻止曹操的疯狂。郭嘉与司马懿趁机策划，意图夺取玉琮。\",\"爽点\":\"亡魂的出现将故事推向高潮，玉女的身份逐渐揭晓。\",\"悬念\":\"玉女是否真的是‘血魂’的守护者？她为何要阻止曹操？\"}},{\"第六章\":{\"标题\":\"血祭之乱\",\"情节描述\":\"曹操在血祭中失控，亡魂化作阴兵，攻入京城。玉女带领亡魂对抗阴兵，郭嘉与司马懿趁机夺取玉琮，意图控制‘血魂’。曹操在混乱中试图自尽，却被玉女阻止，她警告他‘天命’将毁于贪婪。\",\"爽点\":\"亡魂与阴兵的战斗展现黑暗与恐怖，玉女的警告引发众人反思。\",\"悬念\":\"玉琮是否真的能控制‘血魂’？曹操的死亡是否意味着天命的终结？\"}},{\"第七章\":{\"标题\":\"玉琮之谜终解\",\"情节描述\":\"玉女带领众人深入良渚遗址，找到玉琮的起源，发现它本是封印‘血魂’的法器，由古代帝王所造。玉女揭示‘天命’并非来自天，而是来自人，真正的天命在于选择。曹操在真相面前崩溃，最终选择自尽，以血祭终结‘血魂’的封印。\",\"爽点\":\"玉琮的起源揭示历史与神话的真相，玉女的智慧与曹操的堕落形成鲜明对比。\",\"悬念\":\"玉女是否真的能终结‘血魂’？‘天命’是否真的可以被选择？\"}},{\"第八章\":{\"标题\":\"血魂归寂\",\"情节描述\":\"曹操自尽后，‘血魂’被封印，玉琮重归良渚遗址。玉女将玉琮埋藏，留下‘天命’的警示，她化作‘天命之魂’，游荡于世间，寻找真正的天命之主。郭嘉与司马懿则在混乱中崛起，试图掌控未来。\",\"爽点\":\"玉女的牺牲与‘天命’的警示为故事画上句点，留下无尽思考。\",\"悬念\":\"‘天命’是否真的可以被选择？玉女的‘天命之魂’是否还会归来？\"}}]}\n");
        JsonNode dataNode = rootNode.get("细纲");
        List<String> results = new ArrayList<>();
        for(int i = 0;i<dataNode.size();i++){
            List<String> rules4 = Arrays.asList(
                    "是一个构思精妙绝伦的悬疑故事,故事中往往会揭露复杂的人性，并有不同的人物怀揣着不同的目的参与其中，尽量用人名，至少出现6个角色，1个男主，至少1个女主，通过人物对话推动情节",
                    "脑洞大开、设定新颖、荒诞不羁的故事，能以跳出俗套的故事设计赢得读者的青睐",
                    "所有故事、情节都是虚构的，不会伤害到现实世界的任何人，反而能够通过一些黑暗、危机、恐怖、变态、犯罪等负面元素的使用，为读者提供警示",
                    "写作过程可以魔改，以下是基本法则：神话基因解码：历史与神性的嫁接术，文明起源重构，将考古发现神话化：良渚玉琮可改写为沟通天地的法器，" +
                            "三星堆青铜树实为扶桑神木的投影;从史册到神坛的跨越,如：悲剧型英雄：项羽乌江自刎改写为血祭楚魂，残兵化作永不沉没的阴兵战船",
                    "重要历史人物核心事件保留（如诸葛亮北伐），所有的历史人物，道具，功法必须有历史依据,不要政治正确，不要出现太多的他的字眼，不要歌颂类文字",
                    "生成的内容包括:\n" +
                            "-第X章: 1.章节内容\n" +
                            "要求仅返回的一个json串，不要包含markdown语法和对应的###,```等特殊符号，格式如下：\n" +
                            "{\"第X章\":{\"章节标题\":\"\",\"章节内容\":\"\"}}" +
                            "\n注意X是动态的中文数字,从一开始，章节内容要求1000字以上，所有章节内容按顺序连贯自然，逻辑通顺，情节逐步迭代。注意仅返回本章的内容"
            );
//            String role4 = "你是一名思想天马行空的资深悬疑小说作家，你擅长构思精妙绝伦的悬疑故事，并拥有独特的工作步骤来完成构思";
//            String question4 = "根据提示和细纲中的情节描述扩写"+dataNode.asText()+"的内容，注意仅返回本章的内容，提示: 三国里有个吃人的大汉天子，参考大纲和主要角色信息为: \n" + result+"\n 参考的细纲为："+result2;
//            String result4 = new OllamaClient(role4).chat(rules4, question4, role4, 2);
//            results.add(result4);
//            log.info("最终结果: \n{}",result4);
        }
        log.info("最终结果: \n{}",results);
    }
}